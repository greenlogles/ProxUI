{% extends "base.html" %}

{% block title %}Create VM - Proxmox Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-plus-circle"></i> Create New VM/Container</h1>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('create_vm') }}" id="createVmForm">
                    <!-- Type Selection -->
                    <div class="mb-3">
                        <label for="type" class="form-label">Type</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="qemu">Virtual Machine (KVM)</option>
                            <option value="lxc">Container (LXC)</option>
                        </select>
                    </div>

                    <!-- Node Selection -->
                    <div class="mb-3">
                        <label for="node" class="form-label">Node</label>
                        <select class="form-select" id="node" name="node" required>
                            <option value="">Select node...</option>
                            {% for node in nodes %}
                            <option value="{{ node }}">{{ node }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Creation Method -->
                    <div class="mb-3">
                        <label for="creation_method" class="form-label">Creation Method</label>
                        <select class="form-select" id="creation_method" name="creation_method">
                            <option value="blank">Create Blank VM/Container</option>
                            <option value="template">Use Template</option>
                        </select>
                    </div>

                    <!-- Template Selection (hidden by default) -->
                    <div class="mb-3" id="template-group" style="display: none;">
                        <label for="template" class="form-label">Template</label>
                        <select class="form-select" id="template" name="template">
                            <option value="">Loading templates...</option>
                        </select>
                    </div>

                    <!-- Basic Settings -->
                    <div class="mb-3">
                        <label for="vmid" class="form-label">VM ID</label>
                        <input type="number" class="form-control" id="vmid" name="vmid" 
                               min="100" max="999999" required placeholder="e.g., 100">
                    </div>

                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               required placeholder="e.g., my-server">
                    </div>

                    <!-- Hardware Resources -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cores" class="form-label">CPU Cores</label>
                            <input type="number" class="form-control" id="cores" name="cores" 
                                   min="1" max="128" value="2" required>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="memory" class="form-label">Memory (MB)</label>
                            <input type="number" class="form-control" id="memory" name="memory" 
                                   min="512" max="524288" value="2048" step="512" required>
                        </div>

                        <div class="col-md-4 mb-3" id="sockets-group">
                            <label for="sockets" class="form-label">CPU Sockets</label>
                            <input type="number" class="form-control" id="sockets" name="sockets" 
                                   min="1" max="4" value="1" required>
                        </div>
                    </div>

                    <!-- Storage -->
                    <div class="mb-3">
                        <label for="storage" class="form-label">Storage</label>
                        <select class="form-select" id="storage" name="storage" required>
                            <option value="">Select storage...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="disk_size" class="form-label">Disk Size (GB)</label>
                        <input type="number" class="form-control" id="disk_size" name="disk_size" 
                               min="1" max="2048" value="20" required>
                    </div>

                    <!-- Network -->
                    <div class="mb-3">
                        <label for="bridge" class="form-label">Network Bridge</label>
                        <select class="form-select" id="bridge" name="bridge">
                            <option value="">Select network bridge...</option>
                        </select>
                    </div>

                    <!-- Container-specific options -->
                    <div id="lxc-options" style="display: none;">
                        <div class="mb-3">
                            <label for="ostemplate" class="form-label">OS Template</label>
                            <select class="form-select" id="ostemplate" name="ostemplate">
                                <option value="">Select OS template...</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('vms') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get form elements
    const typeSelect = document.getElementById('type');
    const nodeSelect = document.getElementById('node');
    const creationMethodSelect = document.getElementById('creation_method');
    const templateGroup = document.getElementById('template-group');
    const templateSelect = document.getElementById('template');
    const socketsGroup = document.getElementById('sockets-group');
    const storageSelect = document.getElementById('storage');
    const bridgeSelect = document.getElementById('bridge');
    const lxcOptions = document.getElementById('lxc-options');
    const osTemplateSelect = document.getElementById('ostemplate');
    
    // Event listeners for form changes
    typeSelect.addEventListener('change', handleTypeChange);
    nodeSelect.addEventListener('change', handleNodeChange);
    creationMethodSelect.addEventListener('change', handleCreationMethodChange);
    
    // Initial setup
    handleTypeChange();
    
    // Handle VM type change
    function handleTypeChange() {
        const vmType = typeSelect.value;
        
        // Show/hide sockets for VM vs Container
        if (vmType === 'lxc') {
            socketsGroup.style.display = 'none';
            lxcOptions.style.display = 'block';
        } else {
            socketsGroup.style.display = 'block';
            lxcOptions.style.display = 'none';
        }
        
        // Update templates if node is selected
        if (nodeSelect.value) {
            fetchTemplates(nodeSelect.value, vmType);
            // Also refresh storages since they depend on VM type
            fetchStorages(nodeSelect.value);
        }
    }
    
    // Handle node change
    function handleNodeChange() {
        const node = nodeSelect.value;
        if (!node) return;
        
        // Fetch storage options
        fetchStorages(node);
        
        // Fetch network options
        fetchNetworks(node);
        
        // Fetch templates based on current VM type
        fetchTemplates(node, typeSelect.value);
        
        // Fetch next available VMID
        fetchNextVmid(node);
    }
    
    // Handle creation method change
    function handleCreationMethodChange() {
        const method = creationMethodSelect.value;
        
        if (method === 'template') {
            templateGroup.style.display = 'block';
            // Fetch templates if node is selected
            if (nodeSelect.value) {
                fetchTemplates(nodeSelect.value, typeSelect.value);
            }
        } else {
            templateGroup.style.display = 'none';
        }
    }
    
    // Fetch storage options for the selected node
    function fetchStorages(node) {
        const vmType = typeSelect.value;
        fetch(`/api/node/${node}/storages?vm_type=${vmType}`)
            .then(response => response.json())
            .then(data => {
                storageSelect.innerHTML = '<option value="">Select storage...</option>';
                
                if (data.error) {
                    console.error('Error fetching storages:', data.error);
                    return;
                }
                
                data.forEach(storage => {
                    const option = document.createElement('option');
                    option.value = storage.storage;
                    
                    // Create display text with available space information
                    let displayText = `${storage.storage} (${storage.type})`;
                    if (storage.available_gb !== undefined) {
                        displayText += ` - ${storage.available_gb} GB free`;
                    }
                    option.textContent = displayText;
                    storageSelect.appendChild(option);
                });
                
                // Auto-select storage with most available space (already sorted by API)
                if (data.length > 0) {
                    // The API already sorts by available space (most space first)
                    // Filter out storages with very little space (less than 10GB) if alternatives exist
                    const usableStorages = data.filter(s => s.available_gb >= 10);
                    
                    let selectedStorage;
                    if (usableStorages.length > 0) {
                        selectedStorage = usableStorages[0]; // Storage with most space that has at least 10GB
                    } else {
                        selectedStorage = data[0]; // Fallback to any available storage
                    }
                    
                    storageSelect.value = selectedStorage.storage;
                }
            })
            .catch(error => {
                console.error('Error fetching storages:', error);
            });
    }
    
    // Fetch network options for the selected node
    function fetchNetworks(node) {
        fetch(`/api/node/${node}/networks`)
            .then(response => response.json())
            .then(data => {
                bridgeSelect.innerHTML = '<option value="">Select network bridge...</option>';
                
                if (data.error) {
                    console.error('Error fetching networks:', data.error);
                    return;
                }
                
                data.forEach(network => {
                    const option = document.createElement('option');
                    option.value = network.iface;
                    option.textContent = network.iface;
                    bridgeSelect.appendChild(option);
                });
                
                // Select first bridge by default if available
                if (data.length > 0) {
                    bridgeSelect.value = data[0].iface;
                }
            })
            .catch(error => {
                console.error('Error fetching networks:', error);
            });
    }
    
    // Fetch templates for the selected node and VM type
    function fetchTemplates(node, vmType) {
        fetch(`/api/node/${node}/templates`)
            .then(response => response.json())
            .then(data => {
                templateSelect.innerHTML = '<option value="">Select template...</option>';
                osTemplateSelect.innerHTML = '<option value="">Select OS template...</option>';
                
                if (data.error) {
                    console.error('Error fetching templates:', data.error);
                    return;
                }
                
                if (vmType === 'qemu') {
                    // VM templates
                    data.qemu.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.vmid;
                        option.textContent = template.name || `Template VM ${template.vmid}`;
                        templateSelect.appendChild(option);
                    });
                } else {
                    // Container templates
                    data.lxc.forEach(template => {
                        const option = document.createElement('option');
                        option.value = template.volid;
                        option.textContent = template.volid.split('/').pop();
                        osTemplateSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching templates:', error);
            });
    }
    
    // Fetch next available VMID
    function fetchNextVmid(node) {
        fetch(`/api/cluster/nextid`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching next VMID:', data.error);
                    return;
                }
                
                document.getElementById('vmid').value = data.vmid;
            })
            .catch(error => {
                console.error('Error fetching next VMID:', error);
            });
    }
});
</script>
{% endblock %}