{% extends "base.html" %}

{% block title %}Dashboard - Proxmox Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
    </div>
</div>

<div class="row mt-4">
    <!-- Statistics Cards -->
    <div class="col-6 col-lg mb-3">
        <div class="card text-white bg-primary h-100">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1 small">Virtual Machines</h6>
                        <h3 class="mb-0">{{ total_vms }}</h3>
                    </div>
                    <i class="bi bi-pc-display fs-2 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg mb-3">
        <div class="card text-white bg-info h-100">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1 small">Containers</h6>
                        <h3 class="mb-0">{{ total_containers }}</h3>
                    </div>
                    <i class="bi bi-box fs-2 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg mb-3">
        <div class="card text-white bg-secondary h-100">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1 small">Templates</h6>
                        <h3 class="mb-0">{{ total_templates }}</h3>
                    </div>
                    <i class="bi bi-copy fs-2 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg mb-3">
        <div class="card text-white bg-success h-100">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1 small">Running</h6>
                        <h3 class="mb-0">{{ running }}</h3>
                    </div>
                    <i class="bi bi-play-circle fs-2 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg mb-3">
        <div class="card text-white bg-danger h-100">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1 small">Stopped</h6>
                        <h3 class="mb-0">{{ stopped }}</h3>
                    </div>
                    <i class="bi bi-stop-circle fs-2 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Node Metrics -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <h5 class="mb-0"><i class="bi bi-hdd-rack"></i> Node Status</h5>
                <button class="btn btn-sm btn-outline-primary" id="refreshNodes" title="Refresh">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body py-2" id="nodesContainer">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    Loading node metrics...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Top CPU Usage -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> Top CPU Usage</h5>
            </div>
            <div class="card-body">
                {% if top_cpu %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th class="d-none d-md-table-cell">Node</th>
                                <th style="width: 40%">CPU</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vm in top_cpu %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('vm_detail', node=vm.node, vmid=vm.vmid) }}" class="text-decoration-none">
                                        {{ vm.name }}
                                    </a>
                                    <span class="badge bg-{{ 'primary' if vm.type == 'qemu' else 'info' }} ms-1">
                                        {{ 'VM' if vm.type == 'qemu' else 'CT' }}
                                    </span>
                                </td>
                                <td class="d-none d-md-table-cell text-muted">{{ vm.node }}</td>
                                <td>
                                    <div class="progress" style="height: 18px;">
                                        <div class="progress-bar bg-{{ 'danger' if vm.cpu_percent > 80 else 'warning' if vm.cpu_percent > 60 else 'success' }}"
                                             style="width: {{ vm.cpu_percent }}%">
                                            {{ "%.1f"|format(vm.cpu_percent) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted text-center py-4">No running VMs</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top Memory Usage -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-memory"></i> Top Memory Usage</h5>
            </div>
            <div class="card-body">
                {% if top_memory %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th class="d-none d-md-table-cell">Node</th>
                                <th style="width: 40%">Memory</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vm in top_memory %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('vm_detail', node=vm.node, vmid=vm.vmid) }}" class="text-decoration-none">
                                        {{ vm.name }}
                                    </a>
                                    <span class="badge bg-{{ 'primary' if vm.type == 'qemu' else 'info' }} ms-1">
                                        {{ 'VM' if vm.type == 'qemu' else 'CT' }}
                                    </span>
                                </td>
                                <td class="d-none d-md-table-cell text-muted">{{ vm.node }}</td>
                                <td>
                                    <div class="progress" style="height: 18px;">
                                        <div class="progress-bar bg-{{ 'danger' if vm.mem_percent > 80 else 'warning' if vm.mem_percent > 60 else 'success' }}"
                                             style="width: {{ vm.mem_percent }}%">
                                            {{ "%.1f"|format(vm.mem_percent) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-muted text-center py-4">No running VMs</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Tasks -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <h5 class="mb-0"><i class="bi bi-list-task"></i> Recent Tasks</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="refreshTasks" title="Refresh Tasks">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <a href="{{ url_for('tasks') }}" class="btn btn-sm btn-outline-secondary">
                        View All
                    </a>
                </div>
            </div>
            <div class="card-body p-0" id="tasksContainer" style="max-height: 350px; overflow-y: auto;">
                <div class="text-center p-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Loading recent tasks...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tasksContainer = document.getElementById('tasksContainer');
    const refreshTasksBtn = document.getElementById('refreshTasks');
    const nodesContainer = document.getElementById('nodesContainer');
    const refreshNodesBtn = document.getElementById('refreshNodes');

    // Format uptime
    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        if (days > 0) return `${days}d ${hours}h`;
        const mins = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${mins}m`;
    }

    // Fetch node metrics
    function fetchNodeMetrics() {
        fetch('/api/nodes/status')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(nodes => {
                displayNodeMetrics(nodes);
            })
            .catch(error => {
                console.error('Error fetching node metrics:', error);
                nodesContainer.innerHTML = `<div class="text-danger p-3"><i class="bi bi-exclamation-triangle"></i> Error: ${error.message}</div>`;
            });
    }

    // Display node metrics
    function displayNodeMetrics(nodes) {
        if (!Array.isArray(nodes) || nodes.length === 0) {
            nodesContainer.innerHTML = '<div class="text-muted p-3">No nodes available</div>';
            return;
        }

        let html = '<div class="row g-3">';

        nodes.forEach(node => {
            if (!node.online) {
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="border rounded p-2 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong><i class="bi bi-hdd-network text-danger"></i> ${node.name}</strong>
                                <span class="badge bg-danger">Offline</span>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            // Calculate percentages (same as cluster page)
            const cpuPercent = (node.cpu * 100).toFixed(1);
            const memPercent = ((node.mem_used / node.mem_total) * 100).toFixed(1);
            const memUsedGB = (node.mem_used / 1024 / 1024 / 1024).toFixed(1);
            const memTotalGB = (node.mem_total / 1024 / 1024 / 1024).toFixed(1);

            const cpuColor = cpuPercent > 80 ? 'danger' : cpuPercent > 60 ? 'warning' : 'success';
            const memColor = memPercent > 80 ? 'danger' : memPercent > 60 ? 'warning' : 'info';

            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="border rounded p-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong><i class="bi bi-hdd-network text-success"></i> ${node.name}</strong>
                            <small class="text-muted"><i class="bi bi-clock"></i> ${formatUptime(node.uptime)}</small>
                        </div>
                        <div class="row g-2 small">
                            <div class="col-6">
                                <div class="text-muted mb-1">CPU ${cpuPercent}%</div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-${cpuColor}" style="width: ${cpuPercent}%"></div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-muted mb-1">Mem ${memUsedGB}/${memTotalGB} GB</div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-${memColor}" style="width: ${memPercent}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        nodesContainer.innerHTML = html;
    }

    // Refresh nodes button
    refreshNodesBtn.addEventListener('click', function() {
        const icon = this.querySelector('i');
        icon.classList.add('spin');
        this.disabled = true;

        fetchNodeMetrics();

        setTimeout(() => {
            icon.classList.remove('spin');
            this.disabled = false;
        }, 1000);
    });

    // Initial node metrics load
    fetchNodeMetrics();

    // Auto-refresh node metrics every 10 seconds
    setInterval(fetchNodeMetrics, 10000);

    // Fetch recent tasks for dashboard
    function fetchRecentTasks() {
        fetch('/api/tasks?limit=8')
            .then(response => response.json())
            .then(data => {
                displayDashboardTasks(data);
            })
            .catch(error => {
                console.error('Error fetching recent tasks:', error);
                tasksContainer.innerHTML = '<div class="text-danger p-4"><i class="bi bi-exclamation-triangle"></i> Error loading tasks</div>';
            });
    }
    
    // Display tasks on dashboard
    function displayDashboardTasks(tasks) {
        if (!Array.isArray(tasks) || tasks.length === 0) {
            tasksContainer.innerHTML = '<div class="text-muted p-4"><i class="bi bi-info-circle"></i> No recent tasks</div>';
            return;
        }
        
        const taskTypeNames = {
            'qmstart': 'Start VM',
            'qmstop': 'Stop VM', 
            'qmshutdown': 'Shutdown VM',
            'qmreset': 'Reset VM',
            'qmreboot': 'Reboot VM',
            'qmigrate': 'Migrate VM',
            'qmclone': 'Clone VM',
            'qmcreate': 'Create VM',
            'qmdestroy': 'Destroy VM',
            'qmtemplate': 'Create VM template',
            'vzstart': 'Start Container',
            'vzstop': 'Stop Container',
            'vzshutdown': 'Shutdown Container',
            'vzmigrate': 'Migrate Container',
            'vzclone': 'Clone Container',
            'vzcreate': 'Create Container',
            'vzdestroy': 'Destroy Container',
            'vzdump': 'Backup Container',
            'download': 'Download ISO',
            'aptupdate': 'Update package database',
            'startall': 'Bulk start VMs and Containers',
            'stopall': 'Bulk stop VMs and Containers',
            'srvreload': 'SRV networking - reload',
            'vncproxy': 'VNC Console',
            'clusterjoin': 'Add node to cluster',
            'resize': 'Disk resize'
        };
        
        
        let tasksHtml = '<div class="list-group list-group-flush">';
        
        tasks.forEach((task, index) => {
            if (index >= 8) return; // Limit to 8 tasks for dashboard
            
            const taskType = task.type || 'unknown';
            const taskStatus = task.status || 'unknown';
            const startTime = task.start_time_formatted || 'Unknown';
            const statusClass = task.status_class || 'secondary';
            const node = task.node || 'Unknown';
            const vmid = task.id || '';
            
            const displayName = taskTypeNames[taskType] || taskType.toUpperCase();
            
            // Create VM/Container link if VMID exists
            let vmidDisplay = vmid;
            if (vmid && (taskType.startsWith('qm') || taskType.startsWith('vz'))) {
                vmidDisplay = `VM/CT <a href="/vm/${node}/${vmid}" class="text-decoration-none">${vmid}</a>`;
            }
            
            tasksHtml += `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${displayName}</h6>
                            <p class="mb-1 text-muted small">
                                Node: <span class="badge bg-secondary">${node}</span>
                                ${vmid ? `| ${vmidDisplay}` : ''}
                            </p>
                            
                        </div>
                        <div>
                            <span class="badge bg-${statusClass}">${taskStatus}</span></br>
                            <small class="text-muted">${startTime}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        tasksHtml += '</div>';
        tasksContainer.innerHTML = tasksHtml;
    }
    
    // Refresh tasks button
    refreshTasksBtn.addEventListener('click', function() {
        const originalHtml = this.innerHTML;
        this.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i>';
        this.disabled = true;
        
        fetchRecentTasks();
        
        setTimeout(() => {
            this.innerHTML = originalHtml;
            this.disabled = false;
        }, 1000);
    });
    
    // Initial load
    fetchRecentTasks();
    
    // Auto-refresh every 30 seconds
    setInterval(fetchRecentTasks, 30000);
});
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}